{% extends "base.html" %}

{% block title %}파일 관리{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2><i class="fas fa-file-alt"></i> 파일 관리</h2>

            <!-- 탭 네비게이션 -->
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.admin_home') }}">메타데이터</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.admin_users') }}">사용자 관리</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('admin.admin_files') }}">파일 관리</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin.admin_settings') }}">설정</a>
                </li>
            </ul>

            <!-- 파일 목록 카드 -->
            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mb-0"><i class="fas fa-folder-open"></i> 업로드된 파일 목록</h5>
                        </div>
                        <div class="col-md-6 text-end">
                            <span id="totalCount" class="badge bg-primary">총 0개</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 검색 및 필터 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="searchInput"
                                       placeholder="파일명, 교량명, 사용자명으로 검색...">
                                <button class="btn btn-outline-secondary" type="button" id="searchBtn">검색</button>
                                <button class="btn btn-outline-secondary" type="button" id="clearBtn">초기화</button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="perPageSelect">
                                <option value="10">10개씩 보기</option>
                                <option value="25">25개씩 보기</option>
                                <option value="50">50개씩 보기</option>
                                <option value="100">100개씩 보기</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="sortSelect">
                                <option value="upload_date:desc">최신 업로드순</option>
                                <option value="upload_date:asc">오래된 업로드순</option>
                                <option value="filename:asc">파일명 A-Z</option>
                                <option value="filename:desc">파일명 Z-A</option>
                                <option value="bridge_name:asc">교량명 A-Z</option>
                                <option value="bridge_name:desc">교량명 Z-A</option>
                            </select>
                        </div>
                    </div>

                    <!-- 로딩 스피너 -->
                    <div id="loadingSpinner" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <!-- 테이블 -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="filesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>파일명</th>
                                    <th>교량명</th>
                                    <th>구조형식</th>
                                    <th>경간수</th>
                                    <th>업로드 날짜</th>
                                    <th>업로드한 사용자</th>
                                    <th width="150">작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- JavaScript로 동적 로딩 -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 결과 없음 메시지 -->
                    <div id="noResults" class="text-center py-4" style="display: none;">
                        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">검색 결과가 없습니다</h5>
                        <p class="text-muted">다른 검색어를 사용해보세요.</p>
                    </div>

                    <!-- 페이지네이션 -->
                    <nav aria-label="파일 목록 페이지네이션" id="paginationNav" style="display: none;">
                        <ul class="pagination justify-content-center" id="pagination">
                        </ul>
                    </nav>

                    <!-- 페이지 정보 -->
                    <div id="pageInfo" class="text-center text-muted small mt-2" style="display: none;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 파일 삭제 확인 모달 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">파일 삭제 확인</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>정말로 이 파일을 삭제하시겠습니까?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    삭제된 파일은 복구할 수 없습니다.
                </div>
                <div id="deleteFileInfo"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">삭제</button>
            </div>
        </div>
    </div>
</div>

<script>
// 전역 변수
let currentPage = 1;
let currentSearch = '';
let currentSort = 'upload_date:desc';
let currentPerPage = 10;
let deleteFileId = null;

// 페이지 로딩 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    loadFiles();
});

function initializeEventListeners() {
    // 검색 버튼
    document.getElementById('searchBtn').addEventListener('click', performSearch);

    // 엔터키 검색
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    // 초기화 버튼
    document.getElementById('clearBtn').addEventListener('click', function() {
        document.getElementById('searchInput').value = '';
        currentSearch = '';
        currentPage = 1;
        loadFiles();
    });

    // 페이지당 항목 수 변경
    document.getElementById('perPageSelect').addEventListener('change', function() {
        currentPerPage = parseInt(this.value);
        currentPage = 1;
        loadFiles();
    });

    // 정렬 변경
    document.getElementById('sortSelect').addEventListener('change', function() {
        currentSort = this.value;
        currentPage = 1;
        loadFiles();
    });

    // 삭제 확인 버튼
    document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
}

function performSearch() {
    currentSearch = document.getElementById('searchInput').value.trim();
    currentPage = 1;
    loadFiles();
}

function loadFiles() {
    showLoading(true);

    const [sortBy, sortOrder] = currentSort.split(':');
    const params = new URLSearchParams({
        page: currentPage,
        per_page: currentPerPage,
        search: currentSearch,
        sort_by: sortBy,
        sort_order: sortOrder
    });

    fetch(`/admin/api/files?${params}`)
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            if (data.success) {
                displayFiles(data.files);
                displayPagination(data.pagination);
                updateTotalCount(data.pagination.total_count);
            } else {
                showError('파일 목록을 불러오는데 실패했습니다: ' + data.error);
            }
        })
        .catch(error => {
            showLoading(false);
            console.error('Error:', error);
            showError('파일 목록을 불러오는데 실패했습니다.');
        });
}

function displayFiles(files) {
    const tbody = document.querySelector('#filesTable tbody');
    tbody.innerHTML = '';

    if (files.length === 0) {
        document.getElementById('noResults').style.display = 'block';
        document.getElementById('paginationNav').style.display = 'none';
        document.getElementById('pageInfo').style.display = 'none';
        return;
    }

    document.getElementById('noResults').style.display = 'none';

    files.forEach(file => {
        const row = document.createElement('tr');

        // 날짜 포맷팅
        const uploadDate = file[4] ? new Date(file[4]).toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        }) : '미지정';

        row.innerHTML = `
            <td><span class="badge bg-secondary">${file[0]}</span></td>
            <td>
                <div class="fw-bold">
                    <a href="/files/view_file/${file[1]}" class="text-decoration-none text-primary" title="데이터 보기">
                        <i class="fas fa-file-alt me-1"></i>${file[1] || '미지정'}
                    </a>
                </div>
                <small class="text-muted">${file[2] || ''}</small>
            </td>
            <td>${file[3] || '미지정'}</td>
            <td>${file[6] || '-'}</td>
            <td>${file[7] || '-'}</td>
            <td><small>${uploadDate}</small></td>
            <td>
                <span class="badge bg-info">${file[5] || '알 수 없음'}</span>
            </td>
            <td>
                <div class="btn-group" role="group">
                    <a href="/admin/view_file/${file[0]}" class="btn btn-sm btn-primary" title="데이터 보기">
                        <i class="fas fa-eye"></i>
                    </a>
                    <button class="btn btn-sm btn-danger" onclick="showDeleteModal(${file[0]}, '${file[1]}')" title="삭제">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function displayPagination(pagination) {
    const paginationNav = document.getElementById('paginationNav');
    const paginationUl = document.getElementById('pagination');
    const pageInfo = document.getElementById('pageInfo');

    if (pagination.total_pages <= 1) {
        paginationNav.style.display = 'none';
        pageInfo.style.display = 'none';
        return;
    }

    paginationNav.style.display = 'block';
    pageInfo.style.display = 'block';

    // 페이지 정보 업데이트
    const start = (pagination.current_page - 1) * pagination.per_page + 1;
    const end = Math.min(start + pagination.per_page - 1, pagination.total_count);
    pageInfo.innerHTML = `${start}-${end} / 총 ${pagination.total_count}개`;

    // 페이지네이션 버튼 생성
    paginationUl.innerHTML = '';

    // 이전 버튼
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${!pagination.has_prev ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${pagination.current_page - 1})">이전</a>`;
    paginationUl.appendChild(prevLi);

    // 페이지 번호들
    const startPage = Math.max(1, pagination.current_page - 2);
    const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);

    if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(1)">1</a>`;
        paginationUl.appendChild(firstLi);

        if (startPage > 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            paginationUl.appendChild(ellipsisLi);
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === pagination.current_page ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        paginationUl.appendChild(li);
    }

    if (endPage < pagination.total_pages) {
        if (endPage < pagination.total_pages - 1) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            paginationUl.appendChild(ellipsisLi);
        }

        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${pagination.total_pages})">${pagination.total_pages}</a>`;
        paginationUl.appendChild(lastLi);
    }

    // 다음 버튼
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${!pagination.has_next ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${pagination.current_page + 1})">다음</a>`;
    paginationUl.appendChild(nextLi);
}

function changePage(page) {
    if (page < 1) return;
    currentPage = page;
    loadFiles();
}

function updateTotalCount(count) {
    document.getElementById('totalCount').textContent = `총 ${count}개`;
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
}

function showError(message) {
    alert(message);
}

function showDeleteModal(fileId, filename) {
    deleteFileId = fileId;
    document.getElementById('deleteFileInfo').innerHTML = `
        <strong>파일명:</strong> ${filename}<br>
        <strong>ID:</strong> ${fileId}
    `;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function confirmDelete() {
    if (!deleteFileId) return;

    fetch(`/admin/api/files/${deleteFileId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            showSuccess('파일이 삭제되었습니다.');
            loadFiles();
        } else {
            showError('삭제에 실패했습니다: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('삭제에 실패했습니다.');
    });
}

function showSuccess(message) {
    // 간단한 성공 메시지 (토스트 알림으로 개선 가능)
    alert(message);
}
</script>

<style>
.table th {
    white-space: nowrap;
}

.btn-group .btn {
    border-radius: 0.375rem !important;
    margin-right: 2px;
}

.pagination .page-link {
    color: #0d6efd;
}

.pagination .page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.badge {
    font-size: 0.75em;
}

#searchInput {
    border-radius: 0.375rem 0 0 0.375rem;
}

.input-group-text {
    background-color: #f8f9fa;
}

/* 파일명 링크 스타일 */
.table td a.text-primary {
    transition: all 0.2s ease;
}

.table td a.text-primary:hover {
    color: #0056b3 !important;
    text-shadow: 0 1px 2px rgba(0, 86, 179, 0.2);
}

.table td a.text-primary:hover i {
    transform: scale(1.1);
    transition: transform 0.2s ease;
}

.table tr:hover {
    background-color: #f8f9fa !important;
}
</style>
{% endblock %}
